<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leave a Review</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
.container { max-width: 480px; margin: 0 auto; padding: 24px 16px; }
.card { background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
h1 { font-size: 24px; margin-bottom: 4px; }
.subtitle { color: #64748b; font-size: 14px; margin-bottom: 24px; }
.stars { display: flex; gap: 8px; margin: 16px 0; justify-content: center; }
.star { font-size: 40px; cursor: pointer; transition: transform 0.15s; user-select: none; }
.star:hover { transform: scale(1.2); }
.star.active { transform: scale(1.1); }
label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 6px; margin-top: 16px; }
textarea, input[type="text"], input[type="tel"] { width: 100%; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 15px; font-family: inherit; resize: vertical; }
textarea { min-height: 80px; }
.recommend-row { display: flex; gap: 12px; margin-top: 8px; }
.recommend-btn { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: #fff; font-size: 15px; cursor: pointer; text-align: center; transition: all 0.15s; }
.recommend-btn.selected { border-color: #2563eb; background: #eff6ff; color: #2563eb; font-weight: 600; }
.btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px; }
.btn-primary { background: #2563eb; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-outline { background: #fff; color: #2563eb; border: 2px solid #2563eb; margin-top: 10px; }
.review-sites { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
.site-btn { display: flex; align-items: center; gap: 10px; padding: 14px 16px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; font-size: 15px; cursor: pointer; text-decoration: none; color: #1e293b; transition: background 0.15s; }
.site-btn:hover { background: #f1f5f9; }
.site-icon { font-size: 24px; }
.referral-entry { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
.referral-entry input { flex: 1; }
.remove-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #ef4444; padding: 4px 8px; }
.add-more { background: none; border: none; color: #2563eb; font-size: 14px; cursor: pointer; margin-top: 4px; font-weight: 500; }
.extra-link { display: block; text-align: center; padding: 16px; background: #eff6ff; border-radius: 8px; color: #2563eb; text-decoration: none; font-weight: 600; margin-top: 16px; }
.hidden { display: none; }
.loading { text-align: center; padding: 40px; color: #64748b; }
.error { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; }
.success-icon { font-size: 64px; text-align: center; margin-bottom: 16px; }
.thank-you { text-align: center; }
</style>
</head>
<body>
<div class="container">
  <div id="loading" class="loading">Loading...</div>
  <div id="error" class="error hidden"></div>
  
  <!-- Step 1: Review Form -->
  <div id="step-review" class="hidden">
    <div class="card">
      <h1>How'd we do? üéØ</h1>
      <p class="subtitle">Your feedback means a lot to us</p>
      
      <label>Rate your experience</label>
      <div class="stars" id="stars"></div>
      
      <label>Would you recommend us?</label>
      <div class="recommend-row">
        <button class="recommend-btn" onclick="setRecommend(true)">üëç Yes!</button>
        <button class="recommend-btn" onclick="setRecommend(false)">üëé Not yet</button>
      </div>
      
      <label>Any additional notes? (optional)</label>
      <textarea id="note" placeholder="Tell us more..."></textarea>
      
      <button class="btn btn-primary" id="submit-review" onclick="submitReview()">Submit Review</button>
    </div>
  </div>
  
  <!-- Step 2: Share to review sites -->
  <div id="step-share" class="hidden">
    <div class="card">
      <div class="success-icon">‚≠ê</div>
      <h1 style="text-align:center">Thank you!</h1>
      <p class="subtitle" style="text-align:center">Want to spread the word? Post your review on:</p>
      <div class="review-sites" id="review-sites"></div>
      <button class="btn btn-outline" onclick="showReferralStep()">Skip ‚Üí Next</button>
    </div>
  </div>
  
  <!-- Step 3: Refer friends -->
  <div id="step-referral" class="hidden">
    <div class="card">
      <h1>Know anyone who'd love our service? ü§ù</h1>
      <p class="subtitle">Help a friend out ‚Äî we'll reach out warmly</p>
      
      <!-- Consent Notice -->
      <div id="consent-box" style="background: #f0f7ff; border: 2px solid #2563eb; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
        <p style="font-size: 14px; color: #1e3a5f; margin: 0 0 12px 0; text-align: center; font-weight: 600;">
          üìã Before sharing, please confirm:
        </p>
        <p style="font-size: 13px; color: #334155; margin: 0 0 12px 0; text-align: center; line-height: 1.5;">
          By entering names and contact information below, I confirm that I have permission from these individuals to share their information, and I consent to having them contacted on my behalf.
        </p>
        <div style="text-align: center;">
          <label style="font-size: 15px; font-weight: 600; color: #1e3a5f; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="consent-check" onchange="toggleReferralForm()" style="width: 20px; height: 20px; accent-color: #2563eb;">
            I consent to share these names
          </label>
        </div>
      </div>

      <div id="referral-form-area" style="display: none;">
        <button class="btn btn-primary" id="pick-contacts-btn" onclick="pickContacts()" style="margin-bottom: 16px; background: linear-gradient(135deg, #2563eb, #0ea5e9);">
          üì± Choose from Contacts (up to 5)
        </button>
        <p style="text-align: center; color: #94a3b8; font-size: 13px; margin: 0 0 12px 0;">‚Äî or enter manually ‚Äî</p>
        <div id="referral-list"></div>
        <button class="add-more" onclick="addReferralRow()">+ Add another friend</button>
        <div id="selected-contacts" style="margin-bottom: 16px;"></div>
        <button class="btn btn-primary" id="submit-referrals" onclick="submitReferrals()">Send Referrals</button>
      </div>
      <button class="btn btn-outline" onclick="showFinalStep()">Skip</button>
    </div>
  </div>
  
  <!-- Step 4: Done + extra link -->
  <div id="step-done" class="hidden">
    <div class="card thank-you">
      <div class="success-icon">üéâ</div>
      <h1>You're awesome!</h1>
      <p class="subtitle">Thanks for your time and feedback.</p>
      <a id="extra-link" class="extra-link hidden" href="#" target="_blank"></a>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://balgzympfreorfixmoko.supabase.co';
const SUPABASE_KEY = 'sb_publishable_xvwbxdUMJ9AUjag_lBPZJw_Kw6eRqwu';

let reviewId = null;
let rating = 0;
let wouldRecommend = null;
let settings = {};
let reviewData = null;

// Supabase REST helper
async function sb(method, table, body, query = '') {
  const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
  const opts = {
    method,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': method === 'PATCH' ? 'return=representation' : (method === 'POST' ? 'return=representation' : undefined),
    },
  };
  if (body) opts.body = JSON.stringify(body);
  // Remove undefined headers
  Object.keys(opts.headers).forEach(k => opts.headers[k] === undefined && delete opts.headers[k]);
  const res = await fetch(url, opts);
  if (!res.ok) {
    const err = await res.text();
    throw new Error(err);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

async function rpc(fn, params) {
  const url = `${SUPABASE_URL}/rest/v1/rpc/${fn}`;
  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(params),
  });
  if (!res.ok) throw new Error(await res.text());
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

async function init() {
  // Get review ID from URL path: /review/{id} or ?id={id}
  const pathParts = window.location.pathname.split('/');
  reviewId = pathParts[pathParts.length - 1];
  if (!reviewId || reviewId === 'index.html') {
    const params = new URLSearchParams(window.location.search);
    reviewId = params.get('id');
  }
  
  if (!reviewId) {
    showError('Invalid review link.');
    return;
  }
  
  try {
    // Fetch review
    const reviews = await sb('GET', 'reviews', null, `?id=eq.${reviewId}&select=*`);
    if (!reviews || reviews.length === 0) {
      showError('Review not found.');
      return;
    }
    reviewData = reviews[0];
    
    // If already completed, show thank you
    if (reviewData.completed_at) {
      showStep('step-done');
      await loadExtraLink();
      return;
    }
    
    // Fetch settings
    const settingsData = await sb('GET', 'settings', null, '?select=*');
    settingsData.forEach(s => settings[s.key] = s.value);
    
    // Build stars
    const starsEl = document.getElementById('stars');
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement('span');
      star.className = 'star';
      star.textContent = '‚òÜ';
      star.onclick = () => setRating(i);
      starsEl.appendChild(star);
    }
    
    showStep('step-review');
  } catch (e) {
    showError('Something went wrong: ' + e.message);
  }
}

function showError(msg) {
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('error').textContent = msg;
  document.getElementById('error').classList.remove('hidden');
}

function showStep(id) {
  document.getElementById('loading').classList.add('hidden');
  ['step-review', 'step-share', 'step-referral', 'step-done'].forEach(s => {
    document.getElementById(s).classList.toggle('hidden', s !== id);
  });
}

function setRating(r) {
  rating = r;
  document.querySelectorAll('.star').forEach((el, i) => {
    el.textContent = i < r ? '‚òÖ' : '‚òÜ';
    el.classList.toggle('active', i < r);
    el.style.color = i < r ? '#f59e0b' : '#cbd5e1';
  });
}

function setRecommend(val) {
  wouldRecommend = val;
  document.querySelectorAll('.recommend-btn').forEach((btn, i) => {
    btn.classList.toggle('selected', (i === 0 && val) || (i === 1 && !val));
  });
}

async function submitReview() {
  if (rating === 0) { alert('Please select a rating'); return; }
  if (wouldRecommend === null) { alert('Please tell us if you\'d recommend us'); return; }
  
  const btn = document.getElementById('submit-review');
  btn.disabled = true;
  btn.textContent = 'Submitting...';
  
  try {
    await rpc('submit_review', {
      p_review_id: reviewId,
      p_rating: rating,
      p_would_recommend: wouldRecommend,
      p_note: document.getElementById('note').value || null,
    });
    
    // Show share step with enabled review sites
    const sitesEl = document.getElementById('review-sites');
    sitesEl.innerHTML = '';
    
    const sites = [
      { key: 'google', icon: 'üîç', label: 'Google', urlKey: 'google_review_url', enableKey: 'google_review_enabled' },
      { key: 'facebook', icon: 'üìò', label: 'Facebook', urlKey: 'facebook_review_url', enableKey: 'facebook_review_enabled' },
      { key: 'yelp', icon: '‚≠ê', label: 'Yelp', urlKey: 'yelp_review_url', enableKey: 'yelp_review_enabled' },
    ];
    
    let hasSites = false;
    sites.forEach(site => {
      if (settings[site.enableKey] === 'true' && settings[site.urlKey]) {
        hasSites = true;
        const a = document.createElement('a');
        a.className = 'site-btn';
        a.href = settings[site.urlKey];
        a.target = '_blank';
        a.innerHTML = `<span class="site-icon">${site.icon}</span> Post on ${site.label}`;
        a.onclick = () => {
          rpc('log_review_post', { p_review_id: reviewId, p_platform: site.key });
        };
        sitesEl.appendChild(a);
      }
    });
    
    if (hasSites) {
      showStep('step-share');
    } else {
      showReferralStep();
    }
  } catch (e) {
    alert('Error submitting review: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Submit Review';
  }
}

function toggleReferralForm() {
  const checked = document.getElementById('consent-check').checked;
  document.getElementById('referral-form-area').style.display = checked ? 'block' : 'none';
}

let pickedContacts = [];

async function pickContacts() {
  // Check if Contact Picker API is supported
  if ('contacts' in navigator && 'ContactsManager' in window) {
    try {
      const contacts = await navigator.contacts.select(
        ['name', 'tel'],
        { multiple: true }
      );
      // Limit to 5
      pickedContacts = contacts.slice(0, 5).map(c => ({
        name: (c.name && c.name[0]) || '',
        phone: (c.tel && c.tel[0]) || ''
      })).filter(c => c.name && c.phone);
      
      displayPickedContacts();
    } catch (err) {
      if (err.name !== 'InvalidStateError') {
        alert('Could not access contacts. Please enter them manually below.');
      }
    }
  } else {
    // Fallback: show a friendly message
    alert('Contact picker is not supported on this browser. Please enter names manually below.');
    document.getElementById('pick-contacts-btn').style.display = 'none';
  }
}

function displayPickedContacts() {
  const container = document.getElementById('selected-contacts');
  if (pickedContacts.length === 0) {
    container.innerHTML = '';
    return;
  }
  container.innerHTML = '<p style="font-weight:600; color:#1e3a5f; margin-bottom:8px;">Selected contacts:</p>' +
    pickedContacts.map((c, i) => `
      <div style="display:flex; justify-content:space-between; align-items:center; background:#f0f7ff; border-radius:8px; padding:10px 12px; margin-bottom:6px;">
        <span style="font-weight:500;">${c.name}</span>
        <span style="color:#64748b; font-size:13px;">${c.phone}</span>
        <button onclick="removePickedContact(${i})" style="background:none; border:none; color:#ef4444; font-size:18px; cursor:pointer;">‚úï</button>
      </div>
    `).join('');
}

function removePickedContact(i) {
  pickedContacts.splice(i, 1);
  displayPickedContacts();
}

function showReferralStep() {
  const list = document.getElementById('referral-list');
  list.innerHTML = '';
  pickedContacts = [];
  document.getElementById('selected-contacts').innerHTML = '';
  document.getElementById('consent-check').checked = false;
  document.getElementById('referral-form-area').style.display = 'none';
  // Show/hide contact picker button based on support
  const pickBtn = document.getElementById('pick-contacts-btn');
  if (!('contacts' in navigator && 'ContactsManager' in window)) {
    pickBtn.style.display = 'none';
  }
  addReferralRow();
  showStep('step-referral');
}

function addReferralRow() {
  const list = document.getElementById('referral-list');
  const row = document.createElement('div');
  row.className = 'referral-entry';
  row.innerHTML = `
    <input type="text" placeholder="Friend's name" class="ref-name">
    <input type="tel" placeholder="Phone number" class="ref-phone">
    <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
  `;
  list.appendChild(row);
}

async function submitReferrals() {
  // Combine picked contacts + manually entered ones
  const rows = document.querySelectorAll('.referral-entry');
  const referrals = [...pickedContacts];
  rows.forEach(row => {
    const name = row.querySelector('.ref-name').value.trim();
    const phone = row.querySelector('.ref-phone').value.trim();
    if (name && phone) referrals.push({ name, phone });
  });
  
  if (referrals.length === 0) {
    showFinalStep();
    return;
  }
  
  const btn = document.getElementById('submit-referrals');
  btn.disabled = true;
  btn.textContent = 'Sending...';
  
  try {
    // Get customer from review to link referrals
    const inserts = referrals.map(r => ({
      name: r.name,
      phone: r.phone,
      ref_customer_id: reviewData.customer_id,
      review_id: reviewId,
      status: 'new',
      // assigned_rep_id will be matched by phone or assigned by admin
    }));
    
    // Also try to auto-assign to the same rep as the customer
    const customers = await sb('GET', 'customers', null, `?id=eq.${reviewData.customer_id}&select=rep_id`);
    if (customers && customers[0] && customers[0].rep_id) {
      inserts.forEach(i => i.assigned_rep_id = customers[0].rep_id);
    }
    
    await rpc('submit_referrals', { referrals: inserts });
    showFinalStep();
  } catch (e) {
    alert('Error submitting referrals: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Send Referrals';
  }
}

async function showFinalStep() {
  showStep('step-done');
  await loadExtraLink();
}

async function loadExtraLink() {
  try {
    if (!settings.extra_link_url) {
      const settingsData = await sb('GET', 'settings', null, '?select=*');
      settingsData.forEach(s => settings[s.key] = s.value);
    }
    if (settings.extra_link_url && settings.extra_link_url !== 'https://example.com') {
      const link = document.getElementById('extra-link');
      link.href = settings.extra_link_url;
      link.textContent = settings.extra_link_label || 'Learn More ‚Üí';
      link.classList.remove('hidden');
    }
  } catch (e) { /* ignore */ }
}

init();
</script>
</body>
</html>
