<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Leave a Review</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#e0edff 0%,#f8faff 50%,#fff5f0 100%);color:#1e293b;min-height:100vh;min-height:100dvh;overflow-x:hidden}
.container{max-width:440px;margin:0 auto;padding:24px 16px;min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;justify-content:center}
.screen{display:none;animation:fadeUp .4s ease}
.screen.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.card{background:#fff;border-radius:20px;padding:28px 24px;box-shadow:0 4px 24px rgba(37,99,235,.08),0 1px 4px rgba(0,0,0,.04)}
h1{font-size:22px;font-weight:700;text-align:center;line-height:1.3}
.subtitle{color:#64748b;font-size:15px;text-align:center;margin-top:6px;line-height:1.5}
.emoji-hero{font-size:56px;text-align:center;margin-bottom:12px}

/* Stars */
.stars{display:flex;gap:6px;justify-content:center;margin:20px 0 8px}
.star{font-size:44px;cursor:pointer;transition:transform .15s;user-select:none;-webkit-tap-highlight-color:transparent;line-height:1;padding:4px}
.star:active{transform:scale(1.3)}
.star.on{color:#f59e0b}
.star.off{color:#d1d5db}

/* Inputs */
label.field-label{display:block;font-weight:600;font-size:14px;margin-bottom:6px;margin-top:18px;color:#334155}
textarea,input[type="text"],input[type="tel"]{width:100%;border:2px solid #e2e8f0;border-radius:12px;padding:14px;font-size:16px;font-family:inherit;resize:none;transition:border-color .2s;-webkit-appearance:none}
textarea:focus,input:focus{outline:none;border-color:#60a5fa}
textarea{min-height:80px}

/* Recommend */
.recommend-row{display:flex;gap:12px;margin-top:10px}
.rec-btn{flex:1;padding:14px;border:2px solid #e2e8f0;border-radius:14px;background:#fff;font-size:16px;cursor:pointer;text-align:center;transition:all .2s;-webkit-tap-highlight-color:transparent;font-weight:500}
.rec-btn.sel{border-color:#2563eb;background:#eff6ff;color:#2563eb;font-weight:700}
.rec-btn:active{transform:scale(.97)}

/* Buttons */
.btn{width:100%;padding:16px;border:none;border-radius:14px;font-size:17px;font-weight:700;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent;min-height:52px}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,#2563eb,#3b82f6);color:#fff;box-shadow:0 4px 14px rgba(37,99,235,.3);margin-top:22px}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-secondary{background:#fff;color:#2563eb;border:2px solid #2563eb;margin-top:10px}
.btn-skip{background:transparent;color:#94a3b8;font-size:15px;font-weight:500;margin-top:14px;min-height:44px}

/* Review sites */
.sites{display:flex;flex-direction:column;gap:10px;margin-top:20px}
.site-link{display:flex;align-items:center;gap:12px;padding:16px;border:2px solid #e2e8f0;border-radius:14px;background:#fff;font-size:16px;font-weight:600;cursor:pointer;text-decoration:none;color:#1e293b;transition:all .2s;-webkit-tap-highlight-color:transparent}
.site-link:active{transform:scale(.97);background:#f8fafc}
.site-link .icon{font-size:28px;flex-shrink:0}

/* Consent */
.consent-box{background:#f0f7ff;border:2px solid #bfdbfe;border-radius:14px;padding:16px;margin:18px 0}
.consent-box p{font-size:13px;color:#475569;line-height:1.6;margin-bottom:12px}
.consent-label{display:flex;align-items:flex-start;gap:10px;cursor:pointer;font-size:14px;font-weight:600;color:#1e3a5f;line-height:1.4}
.consent-label input[type="checkbox"]{width:22px;height:22px;margin-top:1px;accent-color:#2563eb;flex-shrink:0;border-radius:6px}

/* Contact picker area */
.picker-area{margin-top:16px}
.manual-rows{margin-top:12px}
.manual-row{display:flex;gap:8px;margin-bottom:10px;align-items:center}
.manual-row input{flex:1;padding:12px;font-size:15px}
.manual-row .x-btn{width:36px;height:36px;border-radius:50%;border:none;background:#fee2e2;color:#ef4444;font-size:18px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.or-divider{text-align:center;color:#94a3b8;font-size:13px;margin:10px 0}

/* Picked contacts preview */
.picked-list{margin-top:14px}
.picked-item{display:flex;justify-content:space-between;align-items:center;background:#f0f7ff;border-radius:10px;padding:10px 14px;margin-bottom:6px}
.picked-item .name{font-weight:600;font-size:14px}
.picked-item .phone{color:#64748b;font-size:13px}
.picked-item .rm{background:none;border:none;color:#ef4444;font-size:18px;cursor:pointer;padding:4px 8px}

.privacy-note{font-size:12px;color:#94a3b8;text-align:center;margin-top:14px;line-height:1.5}

/* Extra link */
.extra-link{display:block;text-align:center;padding:16px;background:#eff6ff;border-radius:14px;color:#2563eb;text-decoration:none;font-weight:700;margin-top:16px;font-size:16px;transition:background .2s}
.extra-link:active{background:#dbeafe}

.hidden{display:none!important}
.loading{text-align:center;padding:60px 20px;color:#64748b;font-size:16px}
.error{background:#fef2f2;color:#dc2626;padding:14px;border-radius:14px;text-align:center;font-weight:500}
</style>
</head>
<body>
<div class="container">
  <div id="loading" class="loading">Loading...</div>
  <div id="error" class="error hidden"></div>

  <!-- Screen 1: Survey -->
  <div id="s1" class="screen">
    <div class="card">
      <div class="emoji-hero">üëã</div>
      <h1>Rate Brian's service</h1>
      <p class="subtitle">Tap the stars ‚Äî be honest!</p>
      <div class="stars" id="stars"></div>

      <label class="field-label">What'd he do great? <span style="color:#94a3b8;font-weight:400">(optional)</span></label>
      <textarea id="note" placeholder="Anything you loved..."></textarea>

      <label class="field-label">Would you recommend us?</label>
      <div class="recommend-row">
        <button class="rec-btn" data-val="yes" onclick="setRec(true)">üëç Yep!</button>
        <button class="rec-btn" data-val="no" onclick="setRec(false)">üëé Not yet</button>
      </div>

      <button class="btn btn-primary" id="btn-submit" onclick="submitReview()">Submit</button>
    </div>
  </div>

  <!-- Screen 2: Review Sites -->
  <div id="s2" class="screen">
    <div class="card">
      <div class="emoji-hero">‚≠ê</div>
      <h1>Thanks! Want to share your experience?</h1>
      <p class="subtitle">A quick review helps others find us</p>
      <div class="sites" id="sites"></div>
      <button class="btn btn-skip" onclick="goReferrals()">Skip ‚Üí</button>
    </div>
  </div>

  <!-- Screen 3: Referrals -->
  <div id="s3" class="screen">
    <div class="card">
      <div class="emoji-hero">ü§ù</div>
      <h1>Want to help a friend?</h1>
      <p class="subtitle">Pick 1‚Äì3 contacts who might need coverage</p>

      <div class="consent-box">
        <p>By sharing contacts below, I confirm I have permission from these individuals to share their info, and I consent to having them contacted on my behalf.</p>
        <label class="consent-label">
          <input type="checkbox" id="consent" onchange="toggleConsent()">
          I agree
        </label>
      </div>

      <div id="contact-area" class="picker-area hidden">
        <button class="btn btn-primary" id="picker-btn" onclick="pickContacts()" style="margin-top:0;background:linear-gradient(135deg,#2563eb,#0ea5e9)">üì± Choose from Contacts</button>
        <div class="or-divider" id="or-divider">‚Äî or enter manually ‚Äî</div>
        <div class="manual-rows" id="manual-rows"></div>

        <div class="picked-list" id="picked-list"></div>

        <button class="btn btn-primary" id="btn-send-refs" onclick="submitReferrals()">Send these to Brian</button>
      </div>

      <p class="privacy-note">üîí We only share the names you pick ‚Äî no full access to your contacts, no data sold. Opt out anytime.</p>
      <button class="btn btn-skip" onclick="goDone()">No worries ‚Äî thanks!</button>
    </div>
  </div>

  <!-- Screen 4: Done -->
  <div id="s4" class="screen">
    <div class="card" style="text-align:center">
      <div class="emoji-hero">üéâ</div>
      <h1>You're awesome!</h1>
      <p class="subtitle">Thanks for your time.</p>
      <a id="extra-link" class="extra-link hidden" href="#" target="_blank"></a>
    </div>
  </div>
</div>

<script>
const SB_URL='https://balgzympfreorfixmoko.supabase.co';
const SB_KEY='sb_publishable_xvwbxdUMJ9AUjag_lBPZJw_Kw6eRqwu';
const H={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};

let reviewId,rating=0,recommend=null,settings={},reviewData=null,picked=[];

async function sb(method,table,body,q=''){
  const r=await fetch(`${SB_URL}/rest/v1/${table}${q}`,{method,headers:{...H,'Prefer':method==='POST'?'return=representation':undefined},body:body?JSON.stringify(body):undefined});
  if(!r.ok)throw new Error(await r.text());
  const t=await r.text();return t?JSON.parse(t):null;
}
async function rpc(fn,p){
  const r=await fetch(`${SB_URL}/rest/v1/rpc/${fn}`,{method:'POST',headers:H,body:JSON.stringify(p)});
  if(!r.ok)throw new Error(await r.text());
  const t=await r.text();return t?JSON.parse(t):null;
}

function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('loading').classList.add('hidden');
  window.scrollTo(0,0);
}

// Stars
function buildStars(){
  const el=document.getElementById('stars');
  for(let i=1;i<=5;i++){
    const s=document.createElement('span');
    s.className='star off';s.textContent='‚òÖ';
    s.onclick=()=>setRating(i);el.appendChild(s);
  }
}
function setRating(r){
  rating=r;
  document.querySelectorAll('.star').forEach((s,i)=>{
    s.classList.toggle('on',i<r);s.classList.toggle('off',i>=r);
  });
}
function setRec(v){
  recommend=v;
  document.querySelectorAll('.rec-btn').forEach(b=>{
    b.classList.toggle('sel',(b.dataset.val==='yes'&&v)||(b.dataset.val==='no'&&!v));
  });
}

async function submitReview(){
  if(!rating){alert('Please tap a star rating');return}
  if(recommend===null){alert('Would you recommend us?');return}
  const btn=document.getElementById('btn-submit');btn.disabled=true;btn.textContent='Sending...';
  try{
    await rpc('submit_review',{p_review_id:reviewId,p_rating:rating,p_would_recommend:recommend,p_note:document.getElementById('note').value||null});
    showReviewSites();
  }catch(e){alert('Error: '+e.message);btn.disabled=false;btn.textContent='Submit'}
}

function showReviewSites(){
  const el=document.getElementById('sites');el.innerHTML='';
  const sites=[
    {key:'google',icon:'üîç',label:'Google',url:'google_review_url',en:'google_review_enabled'},
    {key:'facebook',icon:'üìò',label:'Facebook',url:'facebook_review_url',en:'facebook_review_enabled'},
    {key:'yelp',icon:'‚≠ê',label:'Yelp',url:'yelp_review_url',en:'yelp_review_enabled'},
  ];
  let any=false;
  sites.forEach(s=>{
    if(settings[s.en]==='true'&&settings[s.url]){
      any=true;
      const a=document.createElement('a');a.className='site-link';a.href=settings[s.url];a.target='_blank';
      a.innerHTML=`<span class="icon">${s.icon}</span>Post on ${s.label}`;
      a.onclick=()=>rpc('log_review_post',{p_review_id:reviewId,p_platform:s.key});
      el.appendChild(a);
    }
  });
  any?show('s2'):goReferrals();
}

function goReferrals(){
  picked=[];renderPicked();
  document.getElementById('consent').checked=false;
  document.getElementById('contact-area').classList.add('hidden');
  const mr=document.getElementById('manual-rows');mr.innerHTML='';
  // Detect contact picker
  const hasAPI='contacts' in navigator&&'ContactsManager' in window;
  document.getElementById('picker-btn').classList.toggle('hidden',!hasAPI);
  document.getElementById('or-divider').classList.toggle('hidden',!hasAPI);
  // Always add manual rows
  for(let i=0;i<3;i++)addManualRow();
  show('s3');
}

function toggleConsent(){
  document.getElementById('contact-area').classList.toggle('hidden',!document.getElementById('consent').checked);
}

function addManualRow(){
  const d=document.createElement('div');d.className='manual-row';
  d.innerHTML=`<input type="text" placeholder="Name"><input type="tel" placeholder="Phone"><button class="x-btn" onclick="this.parentElement.remove()">‚úï</button>`;
  document.getElementById('manual-rows').appendChild(d);
}

async function pickContacts(){
  try{
    const c=await navigator.contacts.select(['name','tel'],{multiple:true});
    c.slice(0,3).forEach(x=>{
      const name=(x.name&&x.name[0])||'';const phone=(x.tel&&x.tel[0])||'';
      if(name&&phone)picked.push({name,phone});
    });
    renderPicked();
  }catch(e){if(e.name!=='InvalidStateError')alert('Could not access contacts.')}
}

function renderPicked(){
  const el=document.getElementById('picked-list');
  if(!picked.length){el.innerHTML='';return}
  el.innerHTML='<p style="font-weight:600;font-size:14px;margin-bottom:8px">You picked:</p>'+
    picked.map((c,i)=>`<div class="picked-item"><div><span class="name">${c.name}</span><br><span class="phone">${c.phone}</span></div><button class="rm" onclick="picked.splice(${i},1);renderPicked()">‚úï</button></div>`).join('');
}

async function submitReferrals(){
  const refs=[...picked];
  document.querySelectorAll('.manual-row').forEach(r=>{
    const n=r.querySelector('input[type="text"]').value.trim();
    const p=r.querySelector('input[type="tel"]').value.trim();
    if(n&&p)refs.push({name:n,phone:p});
  });
  if(!refs.length){goDone();return}
  const btn=document.getElementById('btn-send-refs');btn.disabled=true;btn.textContent='Sending...';
  try{
    const inserts=refs.map(r=>({name:r.name,phone:r.phone,ref_customer_id:reviewData.customer_id,review_id:reviewId,status:'new'}));
    try{
      const cust=await sb('GET','customers',null,`?id=eq.${reviewData.customer_id}&select=rep_id`);
      if(cust&&cust[0]&&cust[0].rep_id)inserts.forEach(i=>i.assigned_rep_id=cust[0].rep_id);
    }catch(e){}
    await rpc('submit_referrals',{referrals:inserts});
    goDone();
  }catch(e){alert('Error: '+e.message);btn.disabled=false;btn.textContent='Send these to Brian'}
}

async function goDone(){
  show('s4');
  try{
    if(!settings.extra_link_url){
      const sd=await sb('GET','settings',null,'?select=*');
      sd.forEach(s=>settings[s.key]=s.value);
    }
    if(settings.extra_link_url&&settings.extra_link_url!=='https://example.com'){
      const l=document.getElementById('extra-link');
      l.href=settings.extra_link_url;l.textContent=settings.extra_link_label||'Learn More ‚Üí';l.classList.remove('hidden');
    }
  }catch(e){}
}

async function init(){
  const params=new URLSearchParams(window.location.search);
  const pathParts=window.location.pathname.split('/');
  reviewId=params.get('id')||pathParts[pathParts.length-1];
  if(!reviewId||reviewId==='index.html'){document.getElementById('loading').innerHTML='<div class="error">Invalid review link.</div>';return}
  try{
    const revs=await sb('GET','reviews',null,`?id=eq.${reviewId}&select=*`);
    if(!revs||!revs.length){document.getElementById('loading').innerHTML='<div class="error">Review not found.</div>';return}
    reviewData=revs[0];
    if(reviewData.completed_at){show('s4');await goDone();return}
    const sd=await sb('GET','settings',null,'?select=*');
    sd.forEach(s=>settings[s.key]=s.value);
    buildStars();show('s1');
  }catch(e){document.getElementById('loading').innerHTML=`<div class="error">Something went wrong: ${e.message}</div>`}
}
init();
</script>
</body>
</html>
